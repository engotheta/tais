//add active Class
var current_url = window.location.href.split('/');
var current_url = current_url[current_url.length -1];
$('.nav-bottom-header li.nav-item').removeClass('active');
$('.nav-bottom-header').find('a[href="' + current_url + '"]').parents('li.nav-item').addClass('active');

//  add fixed header when scroll
$('body').scroll(function(e){
    var scrollTop = $('body').scrollTop();
    if(scrollTop > 180){
        $('.top-fixed').addClass('fixed-top');
        // $('.top-fixed').addClass('bg-white-slightly-faded');
        // $('.top-fixed').removeClass('bg-darker-faded');

    } else {
        $('.top-fixed').removeClass('fixed-top');
        // $('.top-fixed').addClass('bg-darker-faded');
        // $('.top-fixed').removeClass('bg-white-slightly-faded');
    }

    scrollBanner()
});

// $('.carousel-control-prev').click(function(e) {
//     console.log(e);
//     $('.carouselExampleFade').carousel('next');
// });
//
// $('.carousel-control-next').click(function() {
//     $('#myCarousel').carousel('next');
// });


///parallax effect on bg
const main_banners = document.querySelectorAll(".parallax-banner");
var banners_offsets = [];
var banners_rates = [];

if(main_banners.length){ 
  main_banners.forEach((banner,index) => {
    banners_offsets.push(0);
    banners_rates.push(0.5);
    bannerPosition = banner.getBoundingClientRect().top+scrollTop
    if(banner.dataset.offset) banners_offsets[index] = parseInt(banner.dataset.offset);
    if(banner.dataset.rate) banners_rates[index] = parseFloat(banner.dataset.rate);
    if ($( window ).width() > 991.98) banner.style.backgroundPosition="0px " + (-1*(banners_offsets[index]))+"px";
    else  banner.style.backgroundPosition="0px 0px";
  });

}


$(window).resize(function(e){
  scrollBanner();
  makeSquareUsingHeight();
  hasReset = false;
});

var hasReset = false;
var scrollTop = 0;
function scrollBanner(){
 if(hasReset && $( window ).width() < 991.98) return

  scrollTop = $('body').scrollTop();
  
  if(main_banners.length  ){
    main_banners.forEach((banner,index) => {
      bannerPosition = banner.getBoundingClientRect().top+scrollTop
      if ($( window ).width() > 991.98)  banner.style.backgroundPosition="0px " + (scrollTop*banners_rates[index]-(banners_offsets[index]))+"px";
      else  {
        banner.style.backgroundPosition="0px 0px";    
        hasReset = true;
      }    
    });
  }
}


function makeSquareUsingHeight(){
  if(squared_items_by_height.length === 0) return;

  squared_items_by_height.forEach(square => {
    square.style.width = getComputedStyle(square,null).height
  })
}


var squared_items_by_height = [];
$(document).ready(function(){
  /// close home pup-up
  const popup_close = document.querySelector(".popup-close");
  if(popup_close){
    popup_close.addEventListener('click',function (){
      document.querySelector(this.dataset.close).classList.add("closed");
    })
  }

  //change scroll to contents
  const scroll_to_content = document.querySelector('.scroll-to-content');

  if(scroll_to_content){
    scroll_to_content.addEventListener('click',function (){
      document.querySelector("#homeContentTether").scrollIntoView( {behavior: "smooth" })
    })
  }

  const scroll_to_top = document.querySelector('.scroll-to-top');

  if(scroll_to_top){
    scroll_to_top.addEventListener('click',function (){
      document.querySelector("header").scrollIntoView( {behavior: "smooth" })
    })
  }

 // toggling search display
 const search_form_container = document.querySelector('.search-form-container');
 const search_toggles = document.querySelectorAll('.search-toggle');
 

 if(search_form_container && search_toggles.length){
   search_toggles.forEach(toggler => {
     toggler.addEventListener('click',()=>{
       search_form_container.classList.toggle('active');
       let menu_btn = document.querySelector('.menu-button');
       if(menu_btn) {
         if(search_form_container.classList.contains('active')) {
           menu_btn.classList.replace('d-flex','d-none');
           if(menu_btn.classList.contains('menu-opened')) menu_btn.click();
         }
         else menu_btn.classList.replace('d-none','d-flex')
       }   
     })
   })
 }


  //squares
  squared_items_by_height = document.querySelectorAll('.squared-item-by-height');
  makeSquareUsingHeight();


  //form fields
  var input_fields = document.querySelectorAll(".input-field");
  if(input_fields.length){
    input_fields.forEach(field => {
      field.addEventListener('change', () => {
         if(field.value.length) field.classList.add('filled');
         else field.classList.remove('filled')
      });
      if(field.value.length) field.classList.add('filled');
    })
  }

  //toggle hidden items
  var hidden_items_containers = document.querySelectorAll('.has-hidden-items');
  if(hidden_items_containers.length) hidden_items_containers.forEach(container => {
      container.setAttribute('style','transition:all 0.3s');
      container.querySelectorAll('.hidden-toggler')?.forEach(toggler =>{
        toggler.addEventListener('click',()=>{
          container.classList.toggle('py-3');
          var hidden_items = container.querySelectorAll('.hidden-item');
          if(hidden_items.length) hidden_items.forEach(item =>{
              item.classList.toggle('d-none')
          })
        })
      })
    })
  


  // clickbaits
  var click_baits = document.querySelectorAll(".click-bait");
  if(click_baits.length){
    click_baits.forEach(element => {
      element.addEventListener('click', () => {
         if(!!element.dataset.click) document.querySelector(element.dataset.click).click();
      })
    })
  }

  var files = document.querySelectorAll(".file");
  if(files.length){
    files.forEach(file => {
      file.addEventListener('change', (event) => {
         if(!!file.dataset.display) document.querySelector(file.dataset.display).innerHTML = file.files[0].name;
      })
    })
  }


  // drafts on elements
  var drafted = document.querySelectorAll(".drafted");
  if(drafted.length){
    drafted.forEach(element => {
      element.parentNode.classList.add('has-drafts');

      var draft_container = document.createElement('div');
      draft_container.classList.add('draft-container');
  
      var draft_inner = document.createElement('div');
      draft_inner.classList.add('draft-inner');
  
      var rows = 3 ;
      var cols = 8;
      var order = 1;
  
      for(var i=1; i<=rows; i++){
        var draft_row = document.createElement('div');
        draft_row.classList.add("draft-row");
        draft_inner.appendChild(draft_row);
  
        for(var j=0; j<=cols; j++){
          var dot = document.createElement('span');
          dot.classList.add("dot");
          dot.setAttribute("style","--order:"+order);
          draft_row.appendChild(dot);
          order+=1;
        }
  
        cols -=1;
      }
  
      draft_container.appendChild(draft_inner);
      element.appendChild(draft_container);
    });
  }

  //owl carousel 1
  $(document).ready(function(){
    if(document.querySelector(".owl-carousel")) $(".owl-carousel").owlCarousel({
        nav:true,
        navContainer: '.custom-owl-nav',
        navText: [document.querySelector('.owl-prev-template'),document.querySelector('.owl-next-template')],
        rtl: false,
        loop:true,
        
        autoplay:true,
        autoplayTimeout:3000,
        autoplayHoverPause:true,
       
        dots: true,
        dotsEach:true,
        responsiveClass:true,
        responsive:{
            0:{
                items:1,
                // nav:true
            },
            600:{
                items:2,
                
               
            },
            1000:{
                items:3,
                // nav:true,
            }
        }
    });
});

//owl carousel 1
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-2")) $(".owl-carousel-2").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-2',
      navText: [document.querySelector('.owl-prev-template-2'),document.querySelector('.owl-next-template-2')],
      rtl: false,
      loop:true,
      
      autoplay:true,
      autoplayTimeout:3000,
      autoplayHoverPause:true,
     
      dots: true,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:2,},
          1000:{items:2,
              // nav:true,
          }
      }
  });
});


//owl carousel 1
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-3")) $(".owl-carousel-3").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-3',
      navText: [document.querySelector('.owl-prev-template-3'),document.querySelector('.owl-next-template-3')],
      rtl: false,
      loop:true,
      
      autoplay:true,
      autoplayTimeout:3000,
      autoplayHoverPause:true,
     
      dots: false,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:3,},
          1000:{items:4,
              // nav:true,
          }
      }
  });
});

//owl carousel partners
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-partners")) $(".owl-carousel-partners").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-partners',
      navText: [document.querySelector('.owl-prev-template-partners'),document.querySelector('.owl-next-template-partners')],
      rtl: false,
      loop:true,
      
      autoplay:true,
      autoplayTimeout:5000,
      autoplayHoverPause:true,
     
      dots: true,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:3,},
          1000:{items:4,
              // nav:true,
          }
      }
  });
});
//owl carousel videos
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-services")) $(".owl-carousel-services").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-services',
      navText: [document.querySelector('.owl-prev-template-services'),document.querySelector('.owl-next-template-services')],
      rtl: false,
      loop:true,
      
      autoplay:true,
      autoplayTimeout:5000,
      autoplayHoverPause:true,
     
      dots: true,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:2,},
          1000:{items:3,
              // nav:true,
          }
      }
  });
});
//owl carousel videos
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-videos")) $(".owl-carousel-videos").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-videos',
      navText: [document.querySelector('.owl-prev-template-videos'),document.querySelector('.owl-next-template-videos')],
      rtl: false,
      loop:true,
      
      autoplay:false,
      autoplayTimeout:6000,
      autoplayHoverPause:true,
     
      dots: true,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:2,},
          1000:{items:3,
              // nav:true,
          }
      }
  });
});
//owl carousel leaderw
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-leaders")) $(".owl-carousel-leaders").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-leaders',
      navText: [document.querySelector('.owl-prev-template-leaders'),document.querySelector('.owl-next-template-leaders')],
      rtl: false,
      loop:true,
      
      autoplay:true,
      autoplayTimeout:6000,
      autoplayHoverPause:true,
     
      dots: true,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:3},
          1000:{items:6,
              // nav:true,
          }
      }
  });
});


//owl carousel links
$(document).ready(function(){
  if(document.querySelector(".owl-carousel-links")) $(".owl-carousel-links").owlCarousel({
      nav:true,
      navContainer: '.custom-owl-nav-links',
      navText: [document.querySelector('.owl-prev-template-links'),document.querySelector('.owl-next-template-links')],
      rtl: false,
      loop:true,
      
      autoplay:false,
      // autoplayTimeout:3000,
      // autoplayHoverPause:true,
     
      dots: false,
      dotsEach:true,
      responsiveClass:true,
      responsive:{
          0:{
              items:1,
              // nav:true
          },
          600:{ items:3,},
          1000:{items:4,
              // nav:true,
          }
      }
  });
});



/// swiper
var swiper;
$(document).ready(function(){
  if(document.querySelector(".mySwiper")) {
    swiper = new Swiper(".mySwiper", {
      effect: "creative",
      creativeEffect:{
        prev:{
          shadow:true,
          translate:[0,0,-400],  //2
        },
        next:{
          // shadow:true, //3
          translate:["100%",0,0], //1,2
          
        }
      },
      grabCursor: true,
      speed: 700,
      spaceBetween: 50,

      autoplay: {
        delay: 3000,
      },
    });

    var swiperNext = document.querySelector(".swiper-next");
    if(swiperNext) swiperNext.addEventListener('click',()=>{swiper.slideNext();})

    var swiperPrev = document.querySelector(".swiper-prev");
    if(swiperPrev) swiperPrev.addEventListener('click',()=>{swiper.slidePrev();})

    var swiperIndicators = document.querySelectorAll(".swiper-indicator");
    if(swiperIndicators.length) swiperIndicators.forEach((indicator,index)=>{
      indicator.addEventListener('click',()=>{ swiper.slideTo(index, 700, false)})        
    });

    swiper.on('slideChange', function () {
      console.log( "indexxxxx: ", swiper.activeIndex)
      if(swiperIndicators.length >= swiper.activeIndex+1) {
        var lastActive = document.querySelector(".swiper-indicator.active");
        if(lastActive) lastActive.classList.remove("active");
        swiperIndicators[swiper.activeIndex].classList.add('active');
      }
     
     // swiper.slides
    });
  

  }
});







  //for select2 - activate...
  $('.select2').select2();


  //datables...
    $('.dataTable').dataTable(
        {
            autoWidth: false,
            columnDefs: [
                {
                    targets: ['_all'],
                    className: 'mdc-data-table__cell'
                }
            ],
            "bPaginate": true,
            "bLengthChange": false,
            "bFilter": true,
            "bInfo": true,
            "bAutoWidth": true,
            "oLanguage": {
                "sSearch": " ",
                "oPaginate": {
                    "sPrevious": "<svg viewBox=\"0 0 24 24\" focusable=\"false\" class=\"mat-paginator-icon\"><path d=\"M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6zM6 6h2v12H6z\"></path></svg>",
                    "sNext": "<svg viewBox=\"0 0 24 24\" focusable=\"false\" class=\"mat-paginator-icon\"><path d=\"M5.59 7.41L10.18 12l-4.59 4.59L7 18l6-6-6-6zM16 6h2v12h-2z\"></path></svg>"
                }
            }
        }
    );
    $('input[type="search"]').attr('placeholder','Search ...');

    //DropDown
    $("li.dropdown").hover(
        function() {
            $('.dropdown-menu', this).first().stop( true, true ).slideDown("fast");
            $(this).toggleClass('open');
        },
        function() {
            $('.dropdown-menu', this).first().stop( true, true ).slideUp("fast");
            $(this).toggleClass('open');
        }
    );


    /* Video - Magnific Popup */
    $('.popup-youtube, .popup-vimeo').magnificPopup({
        disableOn: 700,
        type: 'iframe',
        mainClass: 'mfp-fade',
        removalDelay: 160,
        preloader: false,
        fixedContentPos: false,
        iframe: {
            patterns: {
                youtube: {
                    index: 'youtube.com/',
                    id: function(url) {
                        var m = url.match(/[\\?\\&]v=([^\\?\\&]+)/);
                        if ( !m || !m[1] ) return null;
                        return m[1];
                    },
                    src: 'https://www.youtube.com/embed/%id%?autoplay=1'
                },
                vimeo: {
                    index: 'vimeo.com/',
                    id: function(url) {
                        var m = url.match(/(https?:\/\/)?(www.)?(player.)?vimeo.com\/([a-z]*\/)*([0-9]{6,11})[?]?.*/);
                        if ( !m || !m[5] ) return null;
                        return m[5];
                    },
                    src: 'https://player.vimeo.com/video/%id%?autoplay=1'
                }
            }
        }
    });

    //set text color from image colours
    colorThief();

});

$('.carousel').carousel({
    interval: 5000
})

// slick slides
$('.slick-slide1').slick({
   slidesToShow: 6,
   slidesToScroll: 1,
    infinite: true,
    dots: true,
    arrows:false,
    autoplay: true,
   responsive: [
    {
      breakpoint: 1025,
      settings: {
        slidesToShow: 5,
        slidesToScroll: 1,
        infinite: true,
        dots: false
      }
    },
    {
      breakpoint: 769,
      settings: {
        slidesToShow: 4,
        slidesToScroll: 1,
        infinite: true,
        dots: false
      }
    },
    {
      breakpoint: 600,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 1
      }
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 1
      }
    }
  ]
 });

// slick slides
$('.slick-slide2').slick({
   slidesToShow: 2,
   slidesToScroll: 1,
   dots: true,
   arrows:false,
   autoplay: true,
   responsive: [
    {
      breakpoint: 1025,
      settings: {
        slidesToShow: 4,
        slidesToScroll: 1,
        infinite: true,
        dots: false
      }
    },
    {
      breakpoint: 769,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 1,
        infinite: true,
        dots: false
      }
    },
    {
      breakpoint: 600,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 1
      }
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1
      }
    }
  ]


  
 });


 var sheet = "";

 function colorThief(){
   
    //change succestories title color with logo
    const thiefed_image = document.querySelectorAll('.thiefed-image');
    const target_backdrop = document.querySelectorAll('.target-backdrop');
    const target_text = document.querySelectorAll('.target-text');

    if(thiefed_image ){
       sheet = document.createElement('style');

      thiefed_image.forEach((image,index) => {
        //var {r,g,b}= getAverageRGB(image);

         // Make sure image is finished loading

         
        var colorThief = new ColorThief();
        var [r,g,b]=colorThief.getColor(image);

        
        if (image.complete) {
          var [r,g,b]=colorThief.getColor(image);
          if(target_backdrop.length){ 
            target_backdrop[index].classList.add('target-backdrop-'+index);    
            sheet.innerHTML += ".has-hover-color-thief:hover .target-backdrop-"+ index +"{background-color:rgb("+ r + "," + g + "," + b +");}";
          }
          if(target_text.length){ 
            target_text[index].classList.add('target-text-'+index);    
            sheet.innerHTML += ".has-hover-color-thief:hover .target-text-"+ index +"{color:rgb("+ r + "," + g + "," + b +");}";
          }
        } else {
          image.addEventListener('load', function() {
            var [r,g,b]=colorThief.getColor(image);
            colorThief.getColor(image);
            if(target_backdrop.length){ 
              target_backdrop[index].classList.add('target-backdrop-'+index);    
              sheet.innerHTML += ".has-hover-color-thief:hover .target-backdrop-"+ index +"{background-color:rgb("+ r + "," + g + "," + b +");}";
            }
            if(target_text.length){ 
              target_text[index].classList.add('target-text-'+index);    
              sheet.innerHTML += ".has-hover-color-thief:hover .target-text-"+ index +"{color:rgb("+ r + "," + g + "," + b +");}";
            }
          });
        }

       
      });

      document.body.appendChild(sheet);
    }

 }





 function getAverageRGB(imgEl) {

  var blockSize = 5, // only visit every 5 pixels
      defaultRGB = {r:0,g:0,b:0}, // for non-supporting envs
      canvas = document.createElement('canvas'),
      context = canvas.getContext && canvas.getContext('2d'),
      data, width, height,
      i = -4,
      length,
      rgb = {r:0,g:0,b:0},
      count = 0;

  if (!context) {
      return defaultRGB;
  }

  height = canvas.height = imgEl.naturalHeight || imgEl.offsetHeight || imgEl.height;
  width = canvas.width = imgEl.naturalWidth || imgEl.offsetWidth || imgEl.width;

  context.drawImage(imgEl, 0, 0);

  try {
      data = context.getImageData(0, 0, width, height);
  } catch(e) {
      /* security error, img on diff domain */
      return defaultRGB;
  }

  length = data.data.length;

  while ( (i += blockSize * 4) < length ) {
      ++count;
      rgb.r += data.data[i];
      rgb.g += data.data[i+1];
      rgb.b += data.data[i+2];
  }

  // ~~ used to floor values
  rgb.r = ~~(rgb.r/count);
  rgb.g = ~~(rgb.g/count);
  rgb.b = ~~(rgb.b/count);

  return rgb;

}


// faqs search
const faqListSelect = document.querySelector('#selectFaqList');
var noFaqsFields = document.querySelectorAll('.no-faq');
var faqAns  = document.querySelector('.faq-ans');
var submitFaqButton = document.querySelector('.submit-faq');
var allAnsweredFaqs = document.querySelectorAll('.answered-faq');
var faqForm = document.querySelector('.faq-form');

if(faqListSelect) {
  faqListSelect.addEventListener('change',()=>{  showAns() });
  noFaqsFields.forEach(field => field.addEventListener('keyup',()=>{  faqSubmitChanged() }));
  //make all options click show any
}

function showAns(){
  value = faqListSelect.value;
  faqChanged(value);
  faqAns.innerHTML = value;
}

function showAnsFor(faq){
  var matchingFaqs = [];
  allAnsweredFaqs.forEach(x => {if(x.dataset.faq.length == faq.length) matchingFaqs.push(x)})
  if(matchingFaqs.length == 1) faqAns.innerHTML = matchingFaqs[0].dataset.ans;
  if(matchingFaqs.length > 1) matchingFaqs.forEach(x => {if(x.dataset.faq == faq) faqAns.innerHTML = x.dataset.ans})
 
  // faqChanged(faq);
  hideInputs();

  var searchSelect3_Times = document.querySelector('.searchSelect3_Times');
  if(searchSelect3_Times) searchSelect3_Times.addEventListener('click',()=>{
     faqAns.innerHTML = ''; 
     hideInputs();
  });
}

function hideInputs(){
  noFaqsFields.forEach(field => {field.classList.add('d-none')});
  submitFaqButton.classList.add('d-none');
  faqAns.classList.remove('d-none');
}

function faqChanged(){
  faqAns.innerHTML ='';
  //show fields if value and no faqs on list
  var firstFaq = document.querySelector('.searchSelect3_List').querySelector('li');
  if(!firstFaq ) {
    noFaqsFields.forEach(field => {field.classList.remove('d-none')});
    faqAns.classList.add('d-none');
    submitFaqButton.classList.remove('d-none');
  }
  else {
    noFaqsFields.forEach(field => {field.classList.add('d-none')});
    faqAns.classList.remove('d-none');
    submitFaqButton.classList.add('d-none');
  }
}

function faqSubmitChanged(){
  if(faqForm.reportValidity()) submitFaqButton.disabled = false;
  else submitFaqButton.disabled = true;
}